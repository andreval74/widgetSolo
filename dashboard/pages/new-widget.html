<!-- New Widget Creation Page -->
<div class="new-widget-section">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>üß© Criar Novo Widget</h2>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" onclick="dashboardManager.showSection('contracts')">
                <i class="fas fa-arrow-left"></i> Voltar
            </button>
            <button class="btn btn-outline-primary" onclick="resetForm()">
                <i class="fas fa-refresh"></i> Limpar
            </button>
        </div>
    </div>

    <!-- Etapa 1: Sele√ß√£o de Rede -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <span class="badge bg-primary me-2">1</span>
                Selecionar Rede Blockchain
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <label for="networkSelect" class="form-label">Rede</label>
                    <select id="networkSelect" class="form-select" onchange="selectNetwork()">
                        <option value="">Escolha uma rede...</option>
                        <option value="1">Ethereum Mainnet</option>
                        <option value="56">BNB Smart Chain</option>
                        <option value="137">Polygon</option>
                        <option value="97">BSC Testnet</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="chainId" class="form-label">Chain ID</label>
                    <input type="text" id="chainId" class="form-control" readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- Etapa 2: Endere√ßo do Contrato -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0">
                <span class="badge bg-primary me-2">2</span>
                Endere√ßo do Contrato
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-10">
                    <label for="contractAddress" class="form-label">Endere√ßo do Token</label>
                    <input type="text" id="contractAddress" class="form-control" placeholder="0x..." maxlength="42">
                </div>
                <div class="col-md-2">
                    <label class="form-label invisible">Detectar</label>
                    <button type="button" class="btn btn-primary w-100" onclick="detectContract()" id="detectBtn">
                        <i class="fas fa-search"></i> Detectar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Etapa 3: Informa√ß√µes do Token -->
    <div id="tokenInfoSection" class="card mb-4" style="display: none;">
        <div class="card-header bg-success text-white">
            <h6 class="mb-0">
                <span class="badge bg-light text-success me-2">3</span>
                Informa√ß√µes do Token
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <label for="tokenName" class="form-label">Nome</label>
                    <input type="text" id="tokenName" class="form-control" readonly>
                </div>
                <div class="col-md-4">
                    <label for="tokenSymbol" class="form-label">S√≠mbolo</label>
                    <input type="text" id="tokenSymbol" class="form-control" readonly>
                </div>
                <div class="col-md-4">
                    <label for="tokenDecimals" class="form-label">Decimais</label>
                    <input type="text" id="tokenDecimals" class="form-control" readonly>
                </div>
            </div>
        </div>
    </div>

    <!-- Etapa 4: Configura√ß√£o do Widget -->
    <div id="widgetConfigSection" class="card mb-4" style="display: none;">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0">
                <span class="badge bg-light text-info me-2">4</span>
                Configurar Widget
            </h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <label for="tokenPrice" class="form-label">Pre√ßo por Token (USD)</label>
                    <input type="number" id="tokenPrice" class="form-control" placeholder="0.001" step="0.000001" min="0">
                </div>
                <div class="col-md-6">
                    <label for="totalAmount" class="form-label">Quantidade Total</label>
                    <input type="number" id="totalAmount" class="form-control" placeholder="1000" step="1" min="1">
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-12">
                    <label for="widgetTitle" class="form-label">T√≠tulo do Widget (opcional)</label>
                    <input type="text" id="widgetTitle" class="form-control" placeholder="Venda de Tokens">
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <button type="button" class="btn btn-success btn-lg" onclick="createWidget()">
                    <i class="fas fa-rocket me-2"></i>Criar Widget
                </button>
            </div>
        </div>
    </div>
</div>

<script>
console.log('üöÄ IN√çCIO DO SCRIPT NEW-WIDGET');

// Vari√°veis globais
let selectedNetwork = null;
console.log('‚úÖ Vari√°vel selectedNetwork inicializada');
let detectedToken = null;

// Configura√ß√£o das redes
const networkConfigs = {
    '1': { 
        name: 'Ethereum Mainnet', 
        currency: 'ETH',
        rpc: ['https://eth.llamarpc.com', 'https://rpc.ankr.com/eth']
    },
    '56': { 
        name: 'BNB Smart Chain', 
        currency: 'BNB',
        rpc: ['https://bsc-dataseed.binance.org/', 'https://bsc-dataseed1.binance.org/']
    },
    '137': { 
        name: 'Polygon', 
        currency: 'MATIC',
        rpc: ['https://polygon-rpc.com', 'https://rpc.ankr.com/polygon']
    },
    '97': { 
        name: 'BSC Testnet', 
        currency: 'tBNB',
        rpc: ['https://data-seed-prebsc-1-s1.binance.org:8545/']
    }
};

// Sele√ß√£o de rede
function selectNetwork() {
    const select = document.getElementById('networkSelect');
    const chainId = select.value;
    
    if (chainId) {
        document.getElementById('chainId').value = chainId;
        
        selectedNetwork = {
            chainId: parseInt(chainId),
            ...networkConfigs[chainId]
        };
        
        console.log('üåê Rede selecionada:', selectedNetwork);
        
        // Reset quando trocar de rede
        hideTokenSections();
        document.getElementById('contractAddress').value = '';
        detectedToken = null;
    }
}

// Fun√ß√£o para detectar dados do token - baseada no xcafe
async function fetchTokenData(tokenAddress, provider) {
    try {
        const abi = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function owner() view returns (address)"
        ];
        
        const contract = new ethers.Contract(tokenAddress, abi, provider);
        
        const [name, symbol, decimals, totalSupply, owner] = await Promise.all([
            contract.name().catch(() => ""),
            contract.symbol().catch(() => ""),
            contract.decimals().catch(() => 18),
            contract.totalSupply().catch(() => "0"),
            contract.owner().catch(() => "")
        ]);

        return {
            name,
            symbol,
            decimals: decimals.toString(),
            totalSupply: totalSupply.toString(),
            owner,
            address: tokenAddress
        };
    } catch (error) {
        console.error("‚ùå Erro ao buscar dados do token:", error);
        throw error;
    }
}

// Detectar contrato
async function detectContract() {
    console.log('üîç FUN√á√ÉO detectContract CHAMADA');
    
    const address = document.getElementById('contractAddress').value.trim();
    console.log('üìã Endere√ßo:', address);
    
    if (!selectedNetwork) {
        alert('Por favor, selecione uma rede primeiro');
        return;
    }
    
    if (!address || !/^0x[a-fA-F0-9]{40}$/i.test(address)) {
        alert('Endere√ßo inv√°lido. Use o formato: 0x...');
        return;
    }
    
    const detectBtn = document.getElementById('detectBtn');
    detectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Detectando...';
    detectBtn.disabled = true;
    
    try {
        console.log('üîç Iniciando detec√ß√£o do token:', address);
        console.log('üåê Rede:', selectedNetwork.name);
        
        // Criar provider com RPC da rede selecionada
        const provider = new ethers.providers.JsonRpcProvider(selectedNetwork.rpc[0]);
        
        // Verificar se √© um contrato
        const code = await provider.getCode(address);
        if (code === '0x') {
            throw new Error('Endere√ßo n√£o √© um contrato inteligente');
        }
        
        console.log('‚úÖ Contrato detectado, buscando dados...');
        
        // Buscar dados do token
        const tokenData = await fetchTokenData(address, provider);
        
        if (!tokenData.name || !tokenData.symbol) {
            throw new Error('Contrato n√£o retorna dados de token v√°lidos');
        }
        
        detectedToken = {
            address: address,
            name: tokenData.name,
            symbol: tokenData.symbol,
            decimals: parseInt(tokenData.decimals),
            totalSupply: tokenData.totalSupply,
            owner: tokenData.owner,
            network: selectedNetwork
        };
        
        console.log('üéâ Token detectado com sucesso:', detectedToken);
        
        // Atualizar UI
        document.getElementById('tokenName').value = detectedToken.name;
        document.getElementById('tokenSymbol').value = detectedToken.symbol;
        document.getElementById('tokenDecimals').value = detectedToken.decimals;
        
        // Mostrar se√ß√µes
        document.getElementById('tokenInfoSection').style.display = 'block';
        document.getElementById('widgetConfigSection').style.display = 'block';
        
        // Feedback visual
        detectBtn.innerHTML = '<i class="fas fa-check-circle text-success"></i> Detectado!';
        
        setTimeout(() => {
            detectBtn.innerHTML = '<i class="fas fa-search"></i> Detectar';
            detectBtn.disabled = false;
        }, 2000);
        
    } catch (error) {
        console.error('‚ùå Erro ao detectar token:', error);
        alert('Erro ao detectar token: ' + error.message);
        
        detectBtn.innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> Erro';
        setTimeout(() => {
            detectBtn.innerHTML = '<i class="fas fa-search"></i> Detectar';
            detectBtn.disabled = false;
        }, 2000);
    }
}

// Criar widget
async function createWidget() {
    const price = document.getElementById('tokenPrice').value;
    const amount = document.getElementById('totalAmount').value;
    const title = document.getElementById('widgetTitle').value || 'Venda de Tokens';
    
    if (!detectedToken) {
        alert('Por favor, detecte um token primeiro');
        return;
    }
    
    if (!price || parseFloat(price) <= 0) {
        alert('Insira um pre√ßo v√°lido');
        return;
    }
    
    if (!amount || parseInt(amount) <= 0) {
        alert('Insira uma quantidade v√°lida');
        return;
    }
    
    const widgetData = {
        id: 'widget_' + Date.now(),
        network: selectedNetwork,
        token: detectedToken,
        price: parseFloat(price),
        amount: parseInt(amount),
        title: title,
        createdAt: new Date().toISOString(),
        active: true
    };
    
    console.log('üöÄ Criando widget:', widgetData);
    
    try {
        // Aqui seria feita a chamada para a API para salvar o widget
        // Por enquanto, simular sucesso
        
        alert('üéâ Widget criado com sucesso!\n\n' +
              `Token: ${detectedToken.name} (${detectedToken.symbol})\n` +
              `Rede: ${selectedNetwork.name}\n` +
              `Pre√ßo: ${price} ${selectedNetwork.currency}\n` +
              `Quantidade: ${amount} tokens`);
        
        if (typeof dashboardManager !== 'undefined') {
            dashboardManager.showSection('contracts');
        }
        
    } catch (error) {
        console.error('‚ùå Erro ao criar widget:', error);
        alert('Erro ao criar widget: ' + error.message);
    }
}

// Limpar formul√°rio
function resetForm() {
    document.getElementById('networkSelect').value = '';
    document.getElementById('chainId').value = '';
    document.getElementById('contractAddress').value = '';
    document.getElementById('tokenPrice').value = '';
    document.getElementById('totalAmount').value = '';
    document.getElementById('widgetTitle').value = '';
    
    hideTokenSections();
    
    selectedNetwork = null;
    detectedToken = null;
    
    console.log('üßπ Formul√°rio limpo');
}

// Ocultar se√ß√µes de token
function hideTokenSections() {
    document.getElementById('tokenInfoSection').style.display = 'none';
    document.getElementById('widgetConfigSection').style.display = 'none';
}

// Valida√ß√£o em tempo real do endere√ßo
document.addEventListener('DOMContentLoaded', function() {
    const contractInput = document.getElementById('contractAddress');
    
    if (contractInput) {
        contractInput.addEventListener('input', function() {
            const address = this.value.trim();
            const detectBtn = document.getElementById('detectBtn');
            
            if (address.length === 42 && address.startsWith('0x')) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
                if (detectBtn) detectBtn.disabled = false;
            } else {
                this.classList.remove('is-valid');
                if (address.length > 0) {
                    this.classList.add('is-invalid');
                }
                if (detectBtn) detectBtn.disabled = true;
            }
        });
    }
});

console.log('üìã Sistema de cria√ß√£o de widget carregado');
console.log('üîç Ethers.js dispon√≠vel:', typeof ethers !== 'undefined');
console.log('ü¶ä MetaMask dispon√≠vel:', typeof window.ethereum !== 'undefined');
</script>

<!-- Carregar script externo -->
<script src="../../js/modules/new-widget-manager.js"></script>
